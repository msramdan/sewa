<?php

if (!defined('BASEPATH'))
	exit('No direct script access allowed');

class Peminjaman_model extends CI_Model
{

	public $table = 'peminjaman';
	public $id = 'peminjaman_id';
	public $order = 'DESC';

	function __construct()
	{
		parent::__construct();
	}

	// get all
	function get_all()
	{
		$this->db->join('pegawai', 'pegawai.pegawai_id = peminjaman.karyawan_id', 'left');
		$this->db->join('kendaraan', 'kendaraan.kendaraan_id = peminjaman.kendaraan_id', 'left');
		if ($this->session->userdata('level_id') == 2) {
			$this->db->where('karyawan_id', pegawai_id($this->session->userdata('userid')));
		}
		$this->db->order_by($this->id, $this->order);
		return $this->db->get($this->table)->result();
	}

	function get_all_pengembalian()
	{
		$this->db->join('pegawai', 'pegawai.pegawai_id = peminjaman.karyawan_id', 'left');
		$this->db->join('kendaraan', 'kendaraan.kendaraan_id = peminjaman.kendaraan_id', 'left');
		if ($this->session->userdata('level_id') == 2) {
			$this->db->where('karyawan_id', pegawai_id($this->session->userdata('userid')));
		}
		$this->db->where('status_pengembalian','!=',null);
		$this->db->order_by($this->id, $this->order);
		return $this->db->get($this->table)->result();
	}

	// get data by id
	function get_by_id($id)
	{
		$this->db->join('pegawai', 'pegawai.pegawai_id = peminjaman.karyawan_id', 'left');
		$this->db->join('kendaraan', 'kendaraan.kendaraan_id = peminjaman.kendaraan_id', 'left');
		$this->db->join('unit', 'unit.unit_id = pegawai.unit_id', 'left');
		$this->db->where($this->id, $id);
		return $this->db->get($this->table)->row();
	}

	function generatekodeReq()
	{

		$this->db->select('RIGHT(no_peminjaman,4) as no_peminjaman', false);
		$this->db->order_by("no_peminjaman", "DESC");
		$this->db->limit(1);
		$query = $this->db->get('peminjaman');

		// CEK JIKA DATA ADA
		if ($query->num_rows() <> 0) {
			$data       = $query->row(); // ambil satu baris data
			$kodeReq  = intval($data->no_peminjaman) + 1; // tambah 1
		} else {
			$kodeReq  = 1; // isi dengan 1
		}

		$lastKode = str_pad($kodeReq, 4, "0", STR_PAD_LEFT);
		$tahun    = date("Y");
		$REQ      = "REQ";

		$newKode  = $REQ . "/" . $tahun . "/" . $lastKode;

		return $newKode;  // return kode baru

	}

	// get total rows
	function total_rows($q = NULL)
	{
		$this->db->like('peminjaman_id', $q);
		$this->db->or_like('no_peminjaman', $q);
		$this->db->or_like('karyawan_id', $q);
		$this->db->or_like('kendaraan_id', $q);
		$this->db->or_like('tanggal_request', $q);
		$this->db->or_like('estimasi_pengembalian', $q);
		$this->db->or_like('tujuan', $q);
		$this->db->or_like('keperluan', $q);
		$this->db->or_like('tanggal_approved', $q);
		$this->db->or_like('status_request', $q);
		$this->db->or_like('tanggal_pengembalian', $q);
		$this->db->or_like('photo', $q);
		$this->db->or_like('status_pengembalian', $q);
		$this->db->from($this->table);
		return $this->db->count_all_results();
	}


	// insert data
	function insert($data)
	{
		$this->db->insert($this->table, $data);
	}

	// update data
	function update($id, $data)
	{
		$this->db->where($this->id, $id);
		$this->db->update($this->table, $data);
	}

	// delete data
	function delete($id)
	{
		$this->db->where($this->id, $id);
		$this->db->delete($this->table);
	}
}

/* End of file Peminjaman_model.php */
/* Location: ./application/models/Peminjaman_model.php */
/* Please DO NOT modify this information : */
/* Generated by Harviacode Codeigniter CRUD Generator 2022-06-26 03:40:24 */
/* http://harviacode.com */
